<script lang="ts" setup>
import { useIframeDisplay } from '@/composables/useIframeDisplay'
import { type Simulateur, simulateurs } from '@/data/simulateurs'
import { autocompleteFunctions } from '@/utils/autocompleteFunctions'
import { storeToRefs } from 'pinia'

const { isIframe } = useIframeDisplay()

definePageMeta({
  layout: 'default',
  middleware: 'check-iframe-layout',
  validate ({ params }) {
    return simulateurs.some(s => s.id === params.simulateur_id)
  }
})

const route = useRoute()

const simulateurId = ref(route.params.simulateur_id as string)

const simulateur = computed<Simulateur>(() => {
  // We can safely cast here because we validated the route
  return simulateurs.find(s => s.id === simulateurId.value) as Simulateur
})

const crumbs = computed(() => {
  return [
    { text: 'Accueil', to: '/' },
    { text: 'Simulateurs', to: '/simulateurs' },
    { text: simulateur.value.title, to: `/simulateurs/${simulateur.value.id}` }
  ]
})

// Load pictogram dynamically
const pictogram = ref<string | undefined>()
simulateur.value.pictogram()
  .then((svg) => {
    pictogram.value = svg.default
  })

// Load iframe-resizer script when in iframe mode
onMounted(() => {
  if (isIframe.value) {
    const script = document.createElement('script')
    script.src = 'https://cdn.jsdelivr.net/npm/iframe-resizer@4.3.2/js/iframeResizer.contentWindow.min.js'
    script.async = true
    document.head.appendChild(script)
  }
})
</script>

<template>
  <BrandBackgroundContainer v-if="!isIframe">
    <BreadcrumbSectionContainer :crumbs="crumbs" />
    <SectionContainer
      v-if="simulateur"
      type="page-header"
    >
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-3 fr-col-sm-2 fr-col-md-1">
          <DsfrPictogram
            v-if="pictogram"
            :svg-path="pictogram"
          />
        </div>
        <div class="title-container fr-col-9 fr-col-sm-10 fr-col-md-11">
          <h1 class="fr-h5 fr-m-0">
            {{ simulateur.title }}
          </h1>
        </div>
      </div>
    </SectionContainer>
  </BrandBackgroundContainer>
  <BrandBackgroundContainer
    textured
    blue
  >
    <SectionContainer type="page-footer">
      <div class="fr-grid-row fr-grid-row--gutters">
        <Survey
          :simulateur-id="simulateurId"
          :autocomplete-functions="autocompleteFunctions"
        />
      </div>
    </SectionContainer>
  </BrandBackgroundContainer>
</template>

<style scoped lang="scss">
.title-container {
  display: flex;
  align-items: center;
}
</style>
